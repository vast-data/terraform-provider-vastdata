# Copyright (c) HashiCorp, Inc.
#
# GitLab CI Pipeline for VastData Terraform Provider
# 
# Pipeline stages:
# - build: Comprehensive testing (vet, fmt, unit tests, benchmarks) + cross-platform builds
# - test: Additional quality assurance testing with detailed coverage reporting  
# - release: Manual release to GitHub
#
# Key improvements:
# - go vet and go fmt validation
# - Comprehensive test suite with race detection
# - Performance benchmarks
# - Test coverage reporting (HTML + Cobertura for GitLab)
# - Enhanced error reporting with emojis for better visibility

stages:
  - build
  - test  # e2e testing only
  - release

# source: packaging/ci.Dockerfile
image: 110450271409.dkr.ecr.eu-west-1.amazonaws.com/dev/terraform-plugin:CI-2025-06-06

variables:
#  ORION_BRANCH: comet/master  TODO: use this branch once lb_terraform_sanity [from-upstream] is merged.
  ORION_BRANCH: SKIPCI/vlad/terrafrorm_plugin_tests
  INSTALL_IMAGE: "prev_version"


build_terraform_provider: &build_terraform_provider
  stage: build
  script: |
    set -x
    
    # Run comprehensive testing pipeline
    echo "üîç Running go vet..."
    make vet || {
      echo "‚ùå go vet failed - please fix the issues"
      exit 1
    }
    
    echo "üßπ Running go fmt check..."
    make fmt || {
      echo "‚ùå Code formatting issues found - please run 'make fmt'"
      exit 1
    }
    
    echo "üß™ Running comprehensive test suite..."
    make test || {
      echo "‚ùå Tests failed"
      exit 1
    }
    
    echo "‚ö° Running unit tests with race detection..."
    make test-unit || {
      echo "‚ùå Unit tests with race detection failed"
      exit 1
    }
    
    echo "üèÉ Running performance benchmarks..."
    make test-benchmarks-save || {
      echo "‚ö†Ô∏è  Benchmarks failed (non-blocking)"
      # Create empty benchmarks directory if benchmarks fail
      mkdir -p benchmarks
      echo "Benchmarks failed during CI run" > benchmarks/error.txt
    }
    
    echo "üìä Generating test coverage report..."
    make test-coverage || {
      echo "‚ö†Ô∏è  Coverage report generation failed (non-blocking)"
    }
    
    # Generate cobertura coverage report for GitLab
    if [ -f "coverage/coverage.out" ]; then
      echo "üîÑ Converting coverage to cobertura format for GitLab..."
      go install github.com/boumenot/gocover-cobertura@latest || {
        echo "‚ö†Ô∏è  Failed to install gocover-cobertura"
      }
      
      if command -v gocover-cobertura >/dev/null 2>&1; then
        gocover-cobertura < coverage/coverage.out > coverage/coverage.xml || {
          echo "‚ö†Ô∏è  Cobertura conversion failed (non-blocking)"
          # Create empty coverage.xml so artifact collection doesn't fail
          echo '<?xml version="1.0" encoding="UTF-8"?><coverage></coverage>' > coverage/coverage.xml
        }
        echo "‚úÖ Cobertura coverage report generated"
      else
        echo "‚ö†Ô∏è  gocover-cobertura not available - creating empty coverage.xml"
        echo '<?xml version="1.0" encoding="UTF-8"?><coverage></coverage>' > coverage/coverage.xml
      fi
    else
      echo "‚ö†Ô∏è  No coverage output file found - creating empty coverage.xml"
      mkdir -p coverage
      echo '<?xml version="1.0" encoding="UTF-8"?><coverage></coverage>' > coverage/coverage.xml
    fi
    
    echo "‚úÖ All tests passed!"
    
    # Check for uncommitted changes in generated docs
    echo "üìù Checking generated documentation..."
    make generate-docs
    git diff --exit-code || {
      echo "‚ùå Docs changed. Please run 'make generate-docs' and commit the changes."
      exit 1
    }
    
    # generate artifacts for the provider
    mkdir -p artifacts
    PLATFORMS="linux/amd64 darwin/amd64 windows/amd64"
    
    for PLATFORM in $PLATFORMS; do
      OS=$(echo $PLATFORM | cut -d/ -f1)
      ARCH=$(echo $PLATFORM | cut -d/ -f2)
      EXT=""
      if [ "$OS" = "windows" ]; then
        EXT=".exe"
      fi
    
      OUT_DIR="artifacts/${OS}_${ARCH}"
      BIN_NAME="terraform-provider-vastdata${EXT}"
      SCHEMAS_FILE="artifacts/schemas.yaml"
    
      mkdir -p "$OUT_DIR"
      echo "Building for $OS/$ARCH"
      make GOOS=$OS GOARCH=$ARCH VERSION=$CI_PIPELINE_ID build
    
      cp "build/${OS}_${ARCH}/$BIN_NAME" "$OUT_DIR/"
      make show r automation > $SCHEMAS_FILE
      make show d automation >> $SCHEMAS_FILE
      sed -i '/^Running show with/d' $SCHEMAS_FILE
    
      (
        cd "$OUT_DIR"
        zip "../${OS}_${ARCH}.zip" "$BIN_NAME"
      )
    done
    
    # zip examples of resources and data-sources for running in e2e tests
    zip -r artifacts/examples.zip examples/resources examples/data-sources
  artifacts:
    name: "terraform-bundles-$CI_PIPELINE_ID"
    paths:
      - artifacts/
      - coverage/
      - benchmarks/
    expire_in: 10 days
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/coverage.xml
  tags:
    - vast-dev-builder


build_terraform_provider [stable]:
  <<: *build_terraform_provider
  before_script:
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "$GITLAB_USER_NAME"
  after_script:
    - |
      # Create and push git tag from VERSION file after successful build
      echo "üè∑Ô∏è  Creating git tag from version/VERSION..."
      if [ -f "version/VERSION" ]; then
        VERSION=$(cat version/VERSION | tr -d '\n' | tr -d ' ')
        TAG="v${VERSION}"
        
        echo "üìã Version found: $VERSION"
        echo "üè∑Ô∏è  Creating tag: $TAG"
        
        # Check if tag already exists
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "‚ö†Ô∏è  Tag $TAG already exists, skipping tag creation"
        else
          git tag -a "$TAG" -m "Release $TAG - Automated release from stable build job. Pipeline ID: $CI_PIPELINE_ID, Commit: $CI_COMMIT_SHA, Branch: $CI_COMMIT_REF_NAME"
          
          git push origin "$TAG"
          echo "‚úÖ Successfully created and pushed tag: $TAG"
        fi
      else
        echo "‚ùå version/VERSION file not found!"
      fi
      
      echo "üéâ Stable build and tagging completed successfully!"
  artifacts:
    name: "terraform-bundles-stable-$CI_PIPELINE_ID"
    paths:
      - artifacts/
      - coverage/
      - benchmarks/
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/coverage.xml
  when: manual

e2e_terraform_sanity:
  stage: test
  when: manual
  trigger:
    project: dev/orion
    branch: $ORION_BRANCH
    strategy: depend
  allow_failure: true
  variables:
    VAST_upgrade_to: $INSTALL_IMAGE
    VAST_COMET__KWARG: terraform_plugin_version=${CI_PIPELINE_ID}
    TRIGGER: "lb_terraform_sanity [from-upstream]"


# TODO: need to add GITLAB_USER_EMAIL, GITLAB_USER_NAME, and GITHUB_TOKEN variables to the CI/CD settings in GitLab.
release_terraform_plugin:
  image:
    name: alpine/git
    entrypoint: [""]
  rules:
    - if: '$CI_COMMIT_TAG'
      when: manual
  stage: release
  before_script:
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "$GITLAB_USER_NAME"
  script: |
    set -x
    
    # Ensure this tag was created from the main branch
    echo "Checking if tag was created from main branch..."
    git fetch origin main:main
    TAG=$(git describe --tags --abbrev=0)
    
    # Check if the tag points to a commit that exists in main branch
    if ! git merge-base --is-ancestor $CI_COMMIT_SHA main; then
      echo "‚ùå Error: Tag $TAG was not created from the main branch"
      echo "Tags for release must be created from the main branch only"
      exit 1
    fi
    
    echo "‚úÖ Tag $TAG was created from main branch, proceeding with release..."
    
    TARGET_BRANCH=main
    git remote add github https://oauth2:$GITHUB_TOKEN@github.com/vast-data/terraform-provider-vastdata.git || true    
    git fetch github $TARGET_BRANCH
    git checkout -B $TARGET_BRANCH FETCH_HEAD
    git checkout $CI_COMMIT_SHA -- .
    git commit --allow-empty -am "Terraform Plugin - $TAG
    
      (from $CI_COMMIT_SHA)"
    
    git push -f --tags github HEAD:$TARGET_BRANCH
  when: manual
  tags:
    - vast-dev-builder
